<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ASE Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      @keyframes glow {
        0%, 100% { text-shadow: 0 0 5px #0ea5e9, 0 0 10px #0ea5e9, 0 0 15px #0ea5e9; }
        50% { text-shadow: 0 0 10px #0284c7, 0 0 20px #0284c7, 0 0 30px #0284c7; }
      }
      .text-glow {
        animation: glow 2.5s ease-in-out infinite;
      }
      @keyframes subtle-float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
      }
      .subtle-float {
        animation: subtle-float 4s ease-in-out infinite;
      }
      .hidden-view {
        display: none;
      }
      /* --- Light Theme Overrides --- */
      body.light-theme {
        background-color: #f9fafb; /* bg-gray-50 */
        color: #111827; /* text-gray-900 */
      }
      .light-theme .bg-gray-900 { background-color: #f9fafb; }
      .light-theme .bg-gray-800\/50 { background-color: rgba(255, 255, 255, 0.8); }
      .light-theme .bg-gray-800 { background-color: #f3f4f6; }
      .light-theme .bg-gray-900\/70 { background-color: #f3f4f6; }
      .light-theme .bg-gray-700 { background-color: #e5e7eb; }
      .light-theme .hover\:bg-gray-600:hover { background-color: #d1d5db; }
      .light-theme .text-white { color: #1f2937; }
      .light-theme .text-gray-300 { color: #4b5563; }
      .light-theme .text-gray-400 { color: #6b7280; }
      .light-theme .text-gray-500 { color: #6b7280; }
      .light-theme .border-gray-700 { border-color: #d1d5db; }
      .light-theme .border-gray-600 { border-color: #9ca3af; }
      .light-theme .text-sky-400 { color: #0369a1; }
      .light-theme .hover\:text-sky-300:hover { color: #0ea5e9; }
      .light-theme .text-sky-300 { color: #0284c7; }
      .light-theme .text-glow { animation: none; text-shadow: none; }
      .light-theme .shadow-sky-500\/10 { box-shadow: 0 4px 6px -1px rgb(56 189 248 / 0.1), 0 2px 4px -2px rgb(56 189 248 / 0.1); }
      .light-theme .backdrop-blur-sm { backdrop-filter: blur(4px); }
      .light-theme .divide-gray-700 > :not([hidden]) ~ :not([hidden]) { border-color: #d1d5db; }
      .light-theme .hover\:bg-gray-700\/50:hover { background-color: rgba(243, 244, 246, 0.5); }
      .light-theme .bg-sky-500\/20 { background-color: rgba(14, 165, 233, 0.1); }
      .light-theme .border-sky-400 { border-color: #38bdf8; }
      .light-theme .shadow-sky-500\/20 { box-shadow: 0 10px 15px -3px rgb(14 165 233 / 0.1), 0 4px 6px -4px rgb(14 165 233 / 0.1); }
      .light-theme .border-sky-400\/50 { border-color: rgba(56, 189, 248, 0.5); }
      .light-theme .text-yellow-300 { color: #ca8a04; }
      .light-theme .placeholder-gray-400::placeholder { color: #9ca3af; }
      .light-theme .focus\:ring-offset-gray-800:focus { --tw-ring-offset-color: #f9fafb; }
      .light-theme .bg-sky-900\/50 { background-color: rgba(12, 74, 110, 0.1); }
      .light-theme .border-gray-900 { border-color: #e5e7eb; }
      .light-theme .border-sky-500 { border-color: #0ea5e9; }
      .light-theme .bg-sky-600 { background-color: #0284c7; }
      .light-theme .hover\:bg-sky-500:hover { background-color: #0ea5e9; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="root">
        <!-- SPLASH SCREEN -->
        <div id="splash-screen">
            <div class="flex flex-col items-center justify-center h-screen bg-gray-900">
                <div class="relative">
                    <svg class="w-40 h-40 text-sky-400 subtle-float" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="100" cy="100" r="90" stroke="currentColor" strokeWidth="10" /><path d="M50 125 C 70 100, 80 75, 100 75 S 130 100, 150 125" stroke="currentColor" strokeWidth="8" strokeLinecap="round" /><path d="M70 150 C 85 130, 115 130, 130 150" stroke="currentColor" strokeWidth="8" strokeLinecap="round" /><path d="M90 170 C 95 160, 105 160, 110 170" stroke="currentColor" strokeWidth="8" strokeLinecap="round" /></svg>
                    <div class="absolute inset-0 rounded-full border-4 border-sky-500/50 animate-ping"></div>
                </div>
                <h1 class="mt-8 text-5xl font-bold text-white text-glow">ASE Portal</h1>
            </div>
        </div>

        <!-- AUTH SCREEN -->
        <div id="auth-screen" class="hidden-view">
            <div class="flex items-center justify-center min-h-screen bg-gray-900 p-4">
                <div class="w-full max-w-md p-8 space-y-8 bg-gray-800/50 border border-gray-700 rounded-2xl shadow-2xl shadow-sky-500/10 backdrop-blur-sm">
                    <div class="text-center">
                        <svg class="w-20 h-20 mx-auto text-sky-400" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="100" cy="100" r="90" stroke="currentColor" strokeWidth="10" /><path d="M50 125 C 70 100, 80 75, 100 75 S 130 100, 150 125" stroke="currentColor" strokeWidth="8" strokeLinecap="round" /><path d="M70 150 C 85 130, 115 130, 130 150" stroke="currentColor" strokeWidth="8" strokeLinecap="round" /><path d="M90 170 C 95 160, 105 160, 110 170" stroke="currentColor" strokeWidth="8" strokeLinecap="round" /></svg>
                        <h2 class="mt-6 text-3xl font-bold text-white text-glow">ASE Portal</h2>
                        <p class="mt-2 text-gray-400">Sign in to access your account</p>
                    </div>
                    <form class="mt-8 space-y-6" id="login-form">
                        <p id="login-error" class="text-red-400 text-center text-sm"></p>
                        <div>
                            <label for="email" class="sr-only">Email</label>
                            <input id="email" name="email" type="text" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Email or Username (e.g., admin or john@example.com)" />
                        </div>
                        <div>
                            <label for="password" class="sr-only">Password</label>
                            <input id="password" name="password" type="password" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Password (e.g., admin or password123)" />
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <button type="button" id="nav-to-reset" class="font-medium text-sky-400 hover:text-sky-300">Forgot your password?</button>
                            <button type="button" id="nav-to-signup" class="font-medium text-sky-400 hover:text-sky-300">Don't have an account? Sign Up</button>
                        </div>
                        <div>
                            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 focus:ring-offset-gray-800 transition-colors">Sign in</button>
                        </div>
                    </form>
                    <div class="relative">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-600"></div></div>
                        <div class="relative flex justify-center text-sm"><span class="px-2 bg-gray-800 text-gray-400">Or continue with</span></div>
                    </div>
                    <div>
                        <button id="google-login-btn" class="w-full flex items-center justify-center py-3 px-4 border border-gray-600 rounded-lg shadow-sm text-sm font-medium text-white bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 focus:ring-offset-gray-800 transition-colors">
                            <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.022,35.253,44,30.027,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                            <span class="ml-3">Sign in with Google</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SIGNUP SCREEN -->
        <div id="signup-screen" class="hidden-view">
             <div class="flex items-center justify-center min-h-screen bg-gray-900 p-4">
                <div class="w-full max-w-md p-8 space-y-8 bg-gray-800/50 border border-gray-700 rounded-2xl shadow-2xl shadow-sky-500/10 backdrop-blur-sm">
                    <div class="text-center">
                         <svg class="w-20 h-20 mx-auto text-sky-400" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="100" cy="100" r="90" stroke="currentColor" strokeWidth="10" /><path d="M50 125 C 70 100, 80 75, 100 75 S 130 100, 150 125" stroke="currentColor" strokeWidth="8" strokeLinecap="round" /><path d="M70 150 C 85 130, 115 130, 130 150" stroke="currentColor" strokeWidth="8" strokeLinecap="round" /><path d="M90 170 C 95 160, 105 160, 110 170" stroke="currentColor" strokeWidth="8" strokeLinecap="round" /></svg>
                        <h2 class="mt-6 text-3xl font-bold text-white text-glow">Create Account</h2>
                        <p class="mt-2 text-gray-400">Join the ASE Portal</p>
                    </div>
                    <form class="mt-8 space-y-6" id="signup-form">
                        <p id="signup-error" class="text-red-400 text-center text-sm"></p>
                        <div>
                            <label for="signup-name" class="sr-only">Full Name</label>
                            <input id="signup-name" type="text" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Full Name" />
                        </div>
                        <div>
                            <label for="signup-email" class="sr-only">Email</label>
                            <input id="signup-email" type="email" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Email address" />
                        </div>
                        <div>
                            <label for="signup-password" class="sr-only">Password</label>
                            <input id="signup-password" type="password" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Password" />
                        </div>
                        <div>
                            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 focus:ring-offset-gray-800 transition-colors">Sign up</button>
                        </div>
                    </form>
                    <div class="text-sm text-center">
                        <button id="nav-to-login-from-signup" class="font-medium text-sky-400 hover:text-sky-300">Already have an account? Sign in</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESET PASSWORD SCREEN -->
        <div id="reset-password-screen" class="hidden-view">
            <div class="flex items-center justify-center min-h-screen bg-gray-900 p-4">
                <div class="w-full max-w-md p-8 space-y-8 bg-gray-800/50 border border-gray-700 rounded-2xl shadow-2xl shadow-sky-500/10 backdrop-blur-sm">
                    <div class="text-center">
                        <svg class="w-20 h-20 mx-auto text-sky-400" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="100" cy="100" r="90" stroke="currentColor" strokeWidth="10" /><path d="M50 125 C 70 100, 80 75, 100 75 S 130 100, 150 125" stroke="currentColor" strokeWidth="8" strokeLinecap="round" /><path d="M70 150 C 85 130, 115 130, 130 150" stroke="currentColor" strokeWidth="8" strokeLinecap="round" /><path d="M90 170 C 95 160, 105 160, 110 170" stroke="currentColor" strokeWidth="8" strokeLinecap="round" /></svg>
                        <h2 class="mt-6 text-3xl font-bold text-white text-glow">Reset Password</h2>
                        <p class="mt-2 text-gray-400">Enter your email to reset your password</p>
                    </div>
                    <form class="mt-8 space-y-6" id="reset-password-form">
                        <p id="reset-message" class="text-green-400 text-center text-sm"></p>
                        <div id="reset-form-fields">
                            <div>
                                <label for="email-reset" class="sr-only">Email</label>
                                <input id="email-reset" name="email" type="email" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Email address" />
                            </div>
                            <div>
                                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 focus:ring-offset-gray-800 transition-colors">Reset Password</button>
                            </div>
                        </div>
                    </form>
                    <div class="text-sm text-center">
                        <button id="nav-to-login-from-reset" class="font-medium text-sky-400 hover:text-sky-300">Back to Sign in</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CUSTOMER DASHBOARD -->
        <div id="customer-dashboard" class="hidden-view"></div>

        <!-- ADMIN DASHBOARD -->
        <div id="admin-dashboard" class="hidden-view"></div>

        <!-- PURCHASE MODAL -->
        <div id="purchase-modal-container"></div>

        <!-- NOTIFICATION MODAL (ADMIN) -->
        <div id="notification-modal-container"></div>
        
        <!-- PACKAGE EDIT MODAL (ADMIN) -->
        <div id="package-edit-modal-container"></div>
    </div>

    <script type="module">
        // --- START OF JS LOGIC ---

        // --- GLOBAL STATE & CONSTANTS ---
        const Role = { CUSTOMER: 'CUSTOMER', ADMIN: 'ADMIN' };
        const PackageStatus = { INACTIVE: 'INACTIVE', PENDING: 'PENDING', ACTIVE: 'ACTIVE', EXPIRED: 'EXPIRED', REJECTED: 'REJECTED' };
        const ComplaintStatus = { PENDING: 'PENDING', RESOLVED: 'RESOLVED' };

        let appState = 'SPLASH_SCREEN';
        let currentUser = null;
        let currentTheme = 'dark';

        let users = [
            { id: 'user1', name: 'John Doe', email: 'john@example.com', password: 'password123', role: Role.CUSTOMER, createdAt: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000).toISOString() },
            { id: 'admin', name: 'Admin', email: 'admin', password: 'admin', role: Role.ADMIN, createdAt: new Date().toISOString() },
        ];
        let transactions = [
            { id: 'tx1', userId: 'user1', packageId: 'pkg1', transactionId: 'TX_REJECTED_001', status: PackageStatus.REJECTED, purchaseDate: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString() },
            { id: 'tx2', userId: 'user1', packageId: 'pkg2', transactionId: 'TX_EXPIRED_002', status: PackageStatus.EXPIRED, purchaseDate: new Date(Date.now() - 40 * 24 * 60 * 60 * 1000).toISOString(), activationDate: new Date(Date.now() - 35 * 24 * 60 * 60 * 1000).toISOString(), expiryDate: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString() },
        ];
        let wifiPackages = [
            { id: 'pkg1', name: 'Starter Pack', speed: '50 Mbps', price: 20, durationDays: 30 },
            { id: 'pkg2', name: 'Pro Pack', speed: '200 Mbps', price: 45, durationDays: 30 },
            { id: 'pkg3', name: 'Ultra Pack', speed: '1 Gbps', price: 80, durationDays: 30 },
        ];
        let adminAccount = {
            name: "ASE Portal Admin",
            accountNumber: "123-456-7890"
        };
        let notifications = [];
        let complaints = [];

        // --- UTILS ---
        let audioContext = null;
        const initAudioContext = () => {
          if (audioContext) return;
          try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
          } catch(e) {
            console.error("Web Audio API not supported in this browser");
          }
        };

        const playSound = (type) => {
          try {
            if (!audioContext || audioContext.state === 'closed') return;
            if (audioContext.state === 'suspended') { audioContext.resume(); }

            const context = audioContext;
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(context.destination);
            gainNode.gain.setValueAtTime(0, context.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, context.currentTime + 0.01);
            switch (type) {
              case 'login': oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(440, context.currentTime); oscillator.frequency.linearRampToValueAtTime(880, context.currentTime + 0.2); break;
              case 'click': oscillator.type = 'triangle'; oscillator.frequency.setValueAtTime(880, context.currentTime); break;
              case 'notification': oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(600, context.currentTime); oscillator.frequency.linearRampToValueAtTime(1200, context.currentTime + 0.1); break;
              case 'error': oscillator.type = 'square'; oscillator.frequency.setValueAtTime(300, context.currentTime); oscillator.frequency.linearRampToValueAtTime(150, context.currentTime + 0.15); break;
            }
            oscillator.start(context.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, context.currentTime + 0.2);
            oscillator.stop(context.currentTime + 0.2);
          } catch (error) { console.error("Could not play sound", error); }
        };

        const generateInvoice = (transaction, user, wifiPackage) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(22); doc.text("ASE Portal Invoice", 105, 20, { align: 'center' });
            doc.setFontSize(12); doc.text(`Invoice ID: ${transaction.id}`, 14, 40); doc.text(`Purchase Date: ${new Date(transaction.purchaseDate).toLocaleDateString()}`, 14, 47);
            doc.setFontSize(16); doc.text("Billed To:", 14, 60);
            doc.setFontSize(12); doc.text(user.name, 14, 67); doc.text(user.email, 14, 74);
            doc.line(14, 85, 196, 85);
            doc.setFontSize(14); doc.text("Description", 14, 95); doc.text("Price", 180, 95);
            doc.setFontSize(12); doc.text(`${wifiPackage.name} (${wifiPackage.speed})`, 14, 105); doc.text(`$${wifiPackage.price.toFixed(2)}`, 180, 105); doc.text(`Activation: ${new Date(transaction.activationDate).toLocaleDateString()}`, 14, 112); doc.text(`Expires: ${new Date(transaction.expiryDate).toLocaleDateString()}`, 14, 119);
            doc.line(14, 130, 196, 130);
            doc.setFontSize(16); doc.text("Total", 14, 140); doc.text(`$${wifiPackage.price.toFixed(2)}`, 180, 140);
            doc.setFontSize(10); doc.text("Thank you for your business!", 105, 160, { align: 'center'});
            doc.save(`invoice-${transaction.id}.pdf`);
        };
        
        const exportToCsv = (data, filename) => {
            if (data.length === 0) return;
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(','), ...data.map(row => headers.map(header => { const cell = row[header] === null || row[header] === undefined ? '' : String(row[header]); return `"${cell.replace(/"/g, '""')}"`; }).join(','))];
            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', ''); a.setAttribute('href', url); a.setAttribute('download', `${filename}.csv`);
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        const getStatusPillHTML = (status) => {
            switch (status) {
                case PackageStatus.ACTIVE: return `<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full inline-flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Active</span>`;
                case PackageStatus.PENDING: return `<span class="px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-200 rounded-full inline-flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Pending</span>`;
                case ComplaintStatus.PENDING: return `<span class="px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-200 rounded-full">Pending</span>`;
                case ComplaintStatus.RESOLVED: return `<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-200 rounded-full">Resolved</span>`;
                case PackageStatus.REJECTED: return `<span class="px-2 py-1 text-xs font-semibold text-red-800 bg-red-200 rounded-full inline-flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Rejected</span>`;
                case PackageStatus.EXPIRED: return `<span class="px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-300 rounded-full">Expired</span>`;
                default: return `<span class="px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-300 rounded-full">Inactive</span>`;
            }
        };


        // --- THEME ---
        function applyTheme(theme) {
            localStorage.setItem('ase_portal_theme', theme);
            currentTheme = theme;
            const themeIcon = `
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">${
                theme === 'dark'
                ? `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />` // Sun icon
                : `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />` // Moon icon
            }</svg>`;
            
            document.querySelectorAll('.theme-switcher-btn').forEach(btn => {
                btn.innerHTML = themeIcon;
                btn.setAttribute('aria-label', `Switch to ${theme === 'dark' ? 'light' : 'dark'} mode`);
            });

            if (theme === 'light') {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }
        }
        
        function toggleTheme() {
            playSound('click');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        }

        // --- NAVIGATION & RENDERING ---
        const views = ['splash-screen', 'auth-screen', 'signup-screen', 'reset-password-screen', 'customer-dashboard', 'admin-dashboard'];
        function navigateTo(targetState) {
            playSound('click');
            appState = targetState;
            views.forEach(id => {
                const el = document.getElementById(id);
                if (id === `${appState.toLowerCase().replace(/_/g, '-')}`) {
                    el.classList.remove('hidden-view');
                } else {
                    el.classList.add('hidden-view');
                }
            });
            renderCurrentView();
        }
        
        function renderCurrentView() {
            if (appState === 'CUSTOMER_DASHBOARD' && currentUser) {
                renderCustomerDashboard();
            } else if (appState === 'ADMIN_DASHBOARD' && currentUser) {
                renderAdminDashboard();
            }
             // Re-apply theme to ensure dynamically created elements have correct icons
            applyTheme(currentTheme);
        }
        
        // --- HANDLERS ---
        function handleLogin(e) {
            if (e) e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('login-error');
            
            const user = users.find(u => u.email.trim() === email.trim() && u.password === password);
            if (user) {
                playSound('login');
                currentUser = user;
                navigateTo(user.role === Role.ADMIN ? 'ADMIN_DASHBOARD' : 'CUSTOMER_DASHBOARD');
                errorEl.textContent = '';
            } else {
                playSound('error');
                errorEl.textContent = 'Invalid credentials. Please try again.';
            }
        }

        function handleGoogleLogin() {
            playSound('login');
            const customer = users.find(u => u.role === Role.CUSTOMER);
            if (customer) {
              currentUser = customer;
              navigateTo('CUSTOMER_DASHBOARD');
            }
        }
        
        function handleLogout() {
            playSound('click');
            currentUser = null;
            navigateTo('AUTH_SCREEN');
        }

        function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const errorEl = document.getElementById('signup-error');
            errorEl.textContent = '';
            
            if (!name.trim() || !email.trim() || !password.trim()) {
                playSound('error');
                errorEl.textContent = 'All fields are required.';
                return;
            }
            if (password.length < 6) {
                playSound('error');
                errorEl.textContent = 'Password must be at least 6 characters long.';
                return;
            }
            if (users.find(u => u.email.toLowerCase() === email.toLowerCase().trim())) {
                playSound('error');
                errorEl.textContent = 'An account with this email already exists.';
                return;
            }
            
            const newUser = {
                id: `user_${Date.now()}`, name, email: email.trim(), password, role: Role.CUSTOMER,
                createdAt: new Date().toISOString(),
            };
            users.push(newUser);
            playSound('login');
            currentUser = newUser;
            navigateTo('CUSTOMER_DASHBOARD');
        }
        
        function handleResetPassword(e) {
            e.preventDefault();
            const email = document.getElementById('email-reset').value;
            const messageEl = document.getElementById('reset-message');
            const formFields = document.getElementById('reset-form-fields');
            
            if (email.trim()) {
                const userExists = users.find(u => u.email.toLowerCase() === email.toLowerCase().trim());
                if (userExists) {
                    const newPassword = Math.random().toString(36).slice(-8);
                    users = users.map(u => u.id === userExists.id ? {...u, password: newPassword} : u);
                    console.log(`Password for ${email} has been reset to: ${newPassword}`);
                } else {
                    console.log(`Password reset attempted for non-existent email: ${email}`);
                }
                playSound('notification');
                messageEl.textContent = `If an account exists for ${email}, a password reset has been initiated. (Check console for new password).`;
                formFields.classList.add('hidden-view');
            }
        }

        function handlePurchase(packageId, transactionId) {
            if(!currentUser) return;
            const newTransaction = {
                id: `tx_${Date.now()}`, userId: currentUser.id, packageId, transactionId, status: PackageStatus.PENDING,
                purchaseDate: new Date().toISOString(),
            };
            transactions.push(newTransaction);
            playSound('notification');
            renderCustomerDashboard();
        }

        function handleApprove(transactionId) {
            playSound('notification');
            let approvedTx;
            transactions = transactions.map(t => {
                if (t.id === transactionId) {
                    const now = new Date();
                    const aPackage = wifiPackages.find(p => p.id === t.packageId);
                    const duration = aPackage?.durationDays || 30;
                    const expiry = new Date(now);
                    expiry.setDate(expiry.getDate() + duration);
                    const updatedTx = {...t, status: PackageStatus.ACTIVE, activationDate: now.toISOString(), expiryDate: expiry.toISOString()};
                    approvedTx = updatedTx;
                    return updatedTx;
                }
                return t;
            });
            if (approvedTx) handleSendNotification(approvedTx.userId, "Your recent purchase has been approved and your package is now active!");
            renderAdminDashboard('transactions');
        }

        function handleReject(transactionId) {
            playSound('error');
            let rejectedTx;
            transactions = transactions.map(t => {
                if (t.id === transactionId) {
                    rejectedTx = {...t, status: PackageStatus.REJECTED};
                    return rejectedTx;
                }
                return t;
            });
            if (rejectedTx) handleSendNotification(rejectedTx.userId, `Your purchase with Transaction ID ${rejectedTx.transactionId} has been rejected. Please check the ID and resubmit.`);
            renderAdminDashboard('transactions');
        }
        
        function handleSendNotification(userId, message) {
            playSound('notification');
            const newNotif = {
                id: `notif_${Date.now()}`, userId, message, timestamp: new Date().toISOString(), read: false,
            };
            notifications.push(newNotif);
            if(appState === 'CUSTOMER_DASHBOARD') renderCustomerDashboard();
            if(appState === 'ADMIN_DASHBOARD') renderAdminDashboard('notifications');
        }
        
        function handleMarkAllRead() {
            if (!currentUser) return;
            playSound('click');
            notifications = notifications.map(n => {
                if (n.userId === currentUser.id || n.userId === 'all') {
                    return { ...n, read: true };
                }
                return n;
            });
            renderCurrentView();
        }

        function handleComplaintSubmit(userId, subject, message) {
            const newComplaint = {
                id: `comp_${Date.now()}`, userId, subject, message, status: ComplaintStatus.PENDING,
                timestamp: new Date().toISOString(),
            };
            complaints.push(newComplaint);
            playSound('notification');
            renderCustomerDashboard('support');
        }
        
        function handleResolveComplaint(complaintId) {
            complaints = complaints.map(c => c.id === complaintId ? {...c, status: ComplaintStatus.RESOLVED} : c);
            playSound('notification');
            renderAdminDashboard('complaints');
        }

        function handleAssignId(userId, assignId) {
            users = users.map(u => u.id === userId ? { ...u, assignId } : u);
            playSound('notification');
            handleSendNotification(userId, `Your new Assign ID is: ${assignId}`);
        }

        function handleUpdateCredentials(newUsername, newPass) {
            if (!newUsername.trim() || !newPass.trim()) {
                playSound('error');
                alert('Admin username and password cannot be empty.');
                return;
            }
            users = users.map(u => {
                if (u.role === Role.ADMIN) {
                    const updatedAdmin = {...u, email: newUsername, password: newPass};
                    if(currentUser?.id === u.id) currentUser = updatedAdmin;
                    return updatedAdmin;
                }
                return u;
            });
            playSound('notification');
            renderAdminDashboard('settings');
        }

        function handleUpdateAdminAccount(name, accountNumber) {
            if (!name.trim() || !accountNumber.trim()) {
                playSound('error');
                alert('Account name and number cannot be empty.');
                return;
            }
            adminAccount = { name, accountNumber };
            playSound('notification');
            renderAdminDashboard('settings');
        }

        function handleUpdatePackage(packageId, data) {
            if (!data.name.trim() || !data.speed.trim() || !data.price || data.price <= 0) {
                playSound('error');
                alert('Please provide a valid name, speed, and a price greater than zero.');
                return;
            }
            wifiPackages = wifiPackages.map(p => p.id === packageId ? { ...p, ...data } : p);
            playSound('notification');
            renderAdminDashboard('packages');
        }
        
        // --- CUSTOMER DASHBOARD RENDERING ---
        function renderCustomerDashboard(view = 'dashboard') {
            const dashboardEl = document.getElementById('customer-dashboard');
            const freshCurrentUser = users.find(u => u.id === currentUser.id) || currentUser;
            const userTransactions = transactions.filter(t => t.userId === freshCurrentUser.id).sort((a, b) => new Date(b.purchaseDate).getTime() - new Date(a.purchaseDate).getTime());
            const userComplaints = complaints.filter(c => c.userId === freshCurrentUser.id).sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
            const activeTransaction = userTransactions.find(t => t.status === PackageStatus.ACTIVE);
            const pendingTransaction = userTransactions.find(t => t.status === PackageStatus.PENDING);
            const activePackage = activeTransaction ? wifiPackages.find(p => p.id === activeTransaction.packageId) : null;
            const userNotifications = notifications.filter(n => n.userId === 'all' || n.userId === freshCurrentUser.id);
            const hasUnread = userNotifications.some(n => !n.read);

            let activePackageHTML = '';
            if(activePackage && activeTransaction) {
                const expiryDate = new Date(activeTransaction.expiryDate);
                const daysLeft = Math.max(0, Math.ceil((expiryDate.getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24)));
                activePackageHTML = `
                <div class="mb-10">
                    <div class="bg-sky-500/20 border border-sky-400 p-6 rounded-xl shadow-lg shadow-sky-500/20 backdrop-blur-sm">
                      <h2 class="text-2xl font-bold text-sky-300 mb-2">Active Package</h2>
                      <div class="flex items-center justify-between">
                        <div>
                          <p class="text-xl font-semibold text-white">${activePackage.name}</p>
                          <p class="text-gray-300">${activePackage.speed}</p>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-sky-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.636 18.364a9 9 0 010-12.728m12.728 0a9 9 0 010 12.728m-9.9-2.828a4 4 0 010-5.656m5.656 0a4 4 0 010 5.656m-2.828 2.828a1 1 0 11-1.414-1.414 1 1 0 011.414 1.414z" /></svg>
                      </div>
                      <div class="mt-4 pt-4 border-t border-sky-400/50 flex items-center gap-2 ${daysLeft <= 7 ? 'text-yellow-300' : 'text-gray-200'}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <p class="font-medium">Expires on: ${expiryDate.toLocaleDateString()} (${daysLeft} days left)</p>
                      </div>
                    </div>
                </div>`;
            }
            
            const packagesHTML = wifiPackages.map(pkg => `
              <div class="bg-gray-800/50 border border-gray-700 p-6 rounded-lg backdrop-blur-sm transform hover:scale-105 transition-transform duration-300 hover:border-sky-500 hover:shadow-2xl hover:shadow-sky-500/20">
                <h3 class="text-xl font-bold text-sky-400">${pkg.name}</h3>
                <p class="text-gray-400 mt-1">${pkg.speed}</p>
                <p class="text-4xl font-extrabold text-white my-4">$${pkg.price}<span class="text-lg font-normal text-gray-400">/month</span></p>
                <button data-package-id="${pkg.id}" ${!!pendingTransaction ? 'disabled' : ''} class="buy-btn w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-500 transition-colors duration-300 disabled:bg-gray-600 disabled:cursor-not-allowed disabled:text-gray-400 flex items-center justify-center gap-2">
                  ${!!pendingTransaction ? 'Pending Approval' : 'Buy Now'}
                </button>
              </div>`).join('');

            const historyTableHTML = userTransactions.length > 0 ? userTransactions.map(t => {
                const aPackage = wifiPackages.find(p => p.id === t.packageId);
                return `<tr class="hover:bg-gray-700/50">
                          <td class="p-4 font-medium">${aPackage?.name}</td>
                          <td class="p-4 text-gray-300">${new Date(t.purchaseDate).toLocaleDateString()}</td>
                          <td class="p-4">${getStatusPillHTML(t.status)}</td>
                          <td class="p-4 text-gray-400 font-mono text-sm">${t.transactionId}</td>
                          <td class="p-4">${t.status === PackageStatus.ACTIVE ? `<button data-tx-id="${t.id}" class="download-invoice-btn text-sky-400 hover:text-sky-300" title="Download Invoice"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg></button>` : ''}</td>
                        </tr>`;
            }).join('') : `<tr><td colspan="5" class="text-center p-8 text-gray-400">No purchase history found.</td></tr>`;

            const historyCardsHTML = userTransactions.length > 0 ? userTransactions.map(t => {
                const aPackage = wifiPackages.find(p => p.id === t.packageId);
                return `
                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4 space-y-2">
                        <div class="flex justify-between items-start">
                            <span class="font-medium text-white">${aPackage?.name}</span>
                            ${getStatusPillHTML(t.status)}
                        </div>
                        <p class="text-sm text-gray-300">Date: ${new Date(t.purchaseDate).toLocaleDateString()}</p>
                        <p class="text-sm text-gray-400 font-mono">ID: ${t.transactionId}</p>
                        ${t.status === PackageStatus.ACTIVE ? `<button data-tx-id="${t.id}" class="download-invoice-btn text-sky-400 hover:text-sky-300 flex items-center gap-2 pt-2"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> Download Invoice</button>` : ''}
                    </div>
                `;
            }).join('') : `<div class="text-center p-8 text-gray-400">No purchase history found.</div>`;

            const historyHTML = `
                <h2 class="text-2xl font-bold text-sky-300 mb-6">Your Purchase History</h2>
                <div class="hidden md:block bg-gray-800/50 border border-gray-700 rounded-lg overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-900/70"><tr><th class="p-4">Package</th><th class="p-4">Date</th><th class="p-4">Status</th><th class="p-4">Transaction ID</th><th class="p-4">Invoice</th></tr></thead>
                        <tbody class="divide-y divide-gray-700">${historyTableHTML}</tbody>
                    </table>
                </div>
                <div class="md:hidden space-y-4">${historyCardsHTML}</div>
            `;

            const supportHTML = `
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6">
                    <h2 class="text-2xl font-bold text-sky-300 mb-6">Submit a Complaint</h2>
                    <form id="complaint-form">
                        <div class="mb-4">
                            <label for="subject" class="block text-gray-300 font-medium mb-2">Subject</label>
                            <input type="text" id="subject" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-sky-500" required/>
                        </div>
                        <div class="mb-6">
                            <label for="message" class="block text-gray-300 font-medium mb-2">Message</label>
                            <textarea id="message" rows="5" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-sky-500" required></textarea>
                        </div>
                        <button type="submit" class="w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-500 transition-colors">Submit</button>
                    </form>
                </div>
                <div>
                     <h3 class="text-xl font-bold text-sky-300 mb-4">Your Complaint History</h3>
                      <div class="bg-gray-800/50 border border-gray-700 rounded-lg overflow-hidden">
                        <table class="w-full text-left">
                           <thead class="bg-gray-900/70"><tr><th class="p-4">Date</th><th class="p-4">Subject</th><th class="p-4">Status</th></tr></thead>
                            <tbody class="divide-y divide-gray-700">
                            ${userComplaints.length > 0 ? userComplaints.map(c => `
                                <tr class="hover:bg-gray-700/50">
                                    <td class="p-4 text-gray-300">${new Date(c.timestamp).toLocaleDateString()}</td>
                                    <td class="p-4 font-medium">${c.subject}</td>
                                    <td class="p-4">${getStatusPillHTML(c.status)}</td>
                                </tr>`).join('') : `<tr><td colspan="3" class="text-center p-8 text-gray-400">No complaints filed.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
              </div>`;
              
            const notificationsHTML = `
                <div class="absolute right-0 mt-2 w-full max-w-xs sm:w-80 bg-gray-800 border border-gray-700 rounded-lg shadow-lg z-10">
                    <div class="p-3 font-bold border-b border-gray-700">Notifications</div>
                    <div class="max-h-96 overflow-y-auto">
                        ${userNotifications.length > 0 ? [...userNotifications].reverse().map(n => `
                            <div class="p-3 border-b border-gray-700/50 ${!n.read ? 'bg-sky-900/50' : ''}">
                                <p class="text-sm text-gray-300">${n.message}</p>
                                <p class="text-xs text-gray-500 mt-1">${new Date(n.timestamp).toLocaleString()}</p>
                            </div>`).join('') : '<p class="p-4 text-sm text-gray-400">No new notifications.</p>'}
                    </div>
                    ${hasUnread ? `<div class="p-2 text-center border-t border-gray-700/50"><button id="mark-all-read-btn" class="text-sm font-medium text-sky-400 hover:text-sky-300">Mark all as read</button></div>` : ''}
                </div>`;
                
            const activeClass = 'text-sky-400 border-b-2 border-sky-400';
            const inactiveClass = 'text-gray-400 hover:text-white';
            
            let mainContentHTML = '';
            switch(view) {
                case 'history': mainContentHTML = historyHTML; break;
                case 'support': mainContentHTML = supportHTML; break;
                default: mainContentHTML = `${activePackageHTML} <h2 class="text-2xl font-bold text-sky-300 mb-6">Available Packages</h2> <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">${packagesHTML}</div>`;
            }

            dashboardEl.innerHTML = `
            <div class="min-h-screen bg-gray-900 text-white p-4 sm:p-6 lg:p-8">
              <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4 sm:gap-0">
                <div class="flex-1">
                  <h1 class="text-3xl font-bold text-glow">Welcome, <span class="text-sky-400">${freshCurrentUser.name}</span></h1>
                  ${freshCurrentUser.assignId ? `<p class="text-sm text-gray-400 font-mono mt-1">Assign ID: ${freshCurrentUser.assignId}</p>` : ''}
                </div>
                <div class="flex items-center gap-4 self-end sm:self-center">
                    <button id="theme-switcher-customer" class="theme-switcher-btn text-gray-300 hover:text-white transition-colors"></button>
                    <div class="relative">
                        <button id="notification-bell" class="relative text-gray-300 hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                            ${hasUnread ? '<span class="absolute top-0 right-0 h-3 w-3 rounded-full bg-sky-500 border-2 border-gray-900"></span>' : ''}
                        </button>
                        <div id="notification-dropdown" class="hidden-view">${notificationsHTML}</div>
                    </div>
                    <button id="customer-logout-btn" class="bg-gray-700/50 hover:bg-red-500/50 border border-gray-600 hover:border-red-500 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg> <span class="hidden sm:inline">Logout</span>
                    </button>
                </div>
              </header>
              <div class="w-full overflow-x-auto">
                <div class="flex space-x-4 border-b border-gray-700 mb-6">
                  <button data-view="dashboard" class="customer-nav-btn py-2 px-4 font-medium transition-colors whitespace-nowrap ${view === 'dashboard' ? activeClass : inactiveClass}">Dashboard</button>
                  <button data-view="history" class="customer-nav-btn py-2 px-4 font-medium transition-colors whitespace-nowrap ${view === 'history' ? activeClass : inactiveClass}">Purchase History</button>
                  <button data-view="support" class="customer-nav-btn py-2 px-4 font-medium transition-colors whitespace-nowrap ${view === 'support' ? activeClass : inactiveClass}">Support & Complaints</button>
                </div>
              </div>
              <main id="customer-main-content">${mainContentHTML}</main>
            </div>`;
        }
        
        function renderPurchaseModal(aPackage) {
            const container = document.getElementById('purchase-modal-container');
            container.innerHTML = `
             <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                <div class="bg-gray-800 border border-sky-500 rounded-2xl p-8 max-w-lg w-full shadow-2xl shadow-sky-500/20">
                    <h2 class="text-2xl font-bold text-sky-300 mb-4">Purchase: ${aPackage.name}</h2>
                    <div class="bg-gray-900 p-4 rounded-lg mb-6">
                        <p class="text-gray-300">Please send <span class="font-bold text-white">$${aPackage.price}</span> to the following account:</p>
                        <p class="mt-2 text-lg"><span class="text-gray-400">Name:</span> <span class="font-mono text-sky-400">${adminAccount.name}</span></p>
                        <p><span class="text-gray-400">Account:</span> <span class="font-mono text-sky-400">${adminAccount.accountNumber}</span></p>
                    </div>
                    <form id="purchase-form">
                        <label for="transactionId" class="block text-gray-300 font-medium mb-2">Enter Transaction ID</label>
                        <input type="text" id="transactionId" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="e.g., A1B2C3D4E5" required />
                        <div class="flex flex-col sm:flex-row gap-4 mt-6">
                            <button type="button" id="cancel-purchase" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors">Cancel</button>
                            <button type="submit" class="w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-500 transition-colors">Submit for Approval</button>
                        </div>
                    </form>
                </div>
             </div>`;

            const close = () => { playSound('click'); container.innerHTML = ''; };
            document.getElementById('cancel-purchase').addEventListener('click', close);
            document.getElementById('purchase-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const txId = document.getElementById('transactionId').value;
                if(txId.trim()){
                    playSound('click');
                    handlePurchase(aPackage.id, txId);
                    close();
                }
            });
        }
        
        // --- ADMIN DASHBOARD RENDERING ---
        function renderAdminDashboard(view = 'transactions') {
            const dashboardEl = document.getElementById('admin-dashboard');
            
            const pendingTransactions = transactions.filter(t => t.status === PackageStatus.PENDING);
            const pendingComplaints = complaints.filter(c => c.status === ComplaintStatus.PENDING);
            const customerUsers = users.filter(u => u.role === Role.CUSTOMER);

            // --- TRANSACTIONS VIEW ---
            const transactionsTableHTML = pendingTransactions.map(t => {
                const customer = users.find(u => u.id === t.userId);
                const aPackage = wifiPackages.find(p => p.id === t.packageId);
                return `<tr class="hover:bg-gray-700/50">
                    <td class="p-4 font-medium">${customer?.name}</td><td class="p-4 text-gray-300">${aPackage?.name}</td>
                    <td class="p-4 text-gray-400 font-mono text-sm">${t.transactionId}</td><td class="p-4 text-gray-300">${new Date(t.purchaseDate).toLocaleDateString()}</td>
                    <td class="p-4 flex gap-2">
                        <button data-tx-id="${t.id}" class="approve-btn p-2 bg-green-500/20 text-green-400 rounded-full hover:bg-green-500/40" title="Approve"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                        <button data-tx-id="${t.id}" class="reject-btn p-2 bg-red-500/20 text-red-400 rounded-full hover:bg-red-500/40" title="Reject"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                    </td>
                </tr>`;
            }).join('');
            const transactionsCardsHTML = pendingTransactions.map(t => {
                const customer = users.find(u => u.id === t.userId);
                const aPackage = wifiPackages.find(p => p.id === t.packageId);
                return `<div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4 space-y-2">
                    <div class="flex justify-between items-start">
                        <span class="font-medium text-white">${customer?.name} - ${aPackage?.name}</span>
                        <span class="text-sm text-gray-300">${new Date(t.purchaseDate).toLocaleDateString()}</span>
                    </div>
                    <p class="text-sm text-gray-400 font-mono">ID: ${t.transactionId}</p>
                    <div class="flex gap-2 pt-2">
                         <button data-tx-id="${t.id}" class="approve-btn flex-1 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500/40 py-2 px-3 text-sm flex items-center justify-center gap-2">Approve</button>
                         <button data-tx-id="${t.id}" class="reject-btn flex-1 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/40 py-2 px-3 text-sm flex items-center justify-center gap-2">Reject</button>
                    </div>
                </div>`;
            }).join('');
            const transactionsView = `
                <h2 class="text-2xl font-bold text-sky-300 mb-2">Pending Transaction Approvals</h2>
                <p class="text-gray-400 mb-6">Review submitted transaction IDs. Approve valid payments to activate customer packages or reject them if the ID is incorrect.</p>
                <div class="hidden md:block bg-gray-800/50 border border-gray-700 rounded-lg overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-900/70"><tr><th class="p-4">Customer</th><th class="p-4">Package</th><th class="p-4">Transaction ID</th><th class="p-4">Date</th><th class="p-4">Actions</th></tr></thead>
                        <tbody class="divide-y divide-gray-700">${pendingTransactions.length > 0 ? transactionsTableHTML : `<tr><td colspan="5" class="text-center p-8 text-gray-400">No pending transactions.</td></tr>`}</tbody>
                    </table>
                </div>
                <div class="md:hidden space-y-4">${pendingTransactions.length > 0 ? transactionsCardsHTML : `<div class="text-center p-8 text-gray-400">No pending transactions.</div>`}</div>`;

            // --- HISTORY VIEW ---
            const allTransactions = [...transactions].sort((a, b) => new Date(b.purchaseDate).getTime() - new Date(a.purchaseDate).getTime());
            const historyTableHTML = allTransactions.map(t => {
                const customer = users.find(u => u.id === t.userId);
                const aPackage = wifiPackages.find(p => p.id === t.packageId);
                const isApproved = t.status === PackageStatus.ACTIVE || t.status === PackageStatus.EXPIRED;
                return `<tr class="hover:bg-gray-700/50">
                    <td class="p-4 font-medium">${customer?.name || 'N/A'}</td><td class="p-4 text-gray-300">${aPackage?.name || 'N/A'}</td>
                    <td class="p-4 text-gray-400 font-mono text-sm">${t.transactionId}</td><td class="p-4 text-gray-300">${new Date(t.purchaseDate).toLocaleDateString()}</td>
                    <td class="p-4">${getStatusPillHTML(t.status)}</td>
                    <td class="p-4">${isApproved ? `<button data-tx-id="${t.id}" class="download-admin-invoice-btn text-sky-400 hover:text-sky-300" title="Download Invoice"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg></button>` : ''}</td>
                </tr>`;
            }).join('');
            const historyCardsHTML = allTransactions.map(t => {
                 const customer = users.find(u => u.id === t.userId);
                const aPackage = wifiPackages.find(p => p.id === t.packageId);
                const isApproved = t.status === PackageStatus.ACTIVE || t.status === PackageStatus.EXPIRED;
                return `<div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4 space-y-2">
                    <div class="flex justify-between items-start">
                        <span class="font-medium text-white">${customer?.name || 'N/A'} - ${aPackage?.name || 'N/A'}</span>
                        ${getStatusPillHTML(t.status)}
                    </div>
                    <p class="text-sm text-gray-300">Date: ${new Date(t.purchaseDate).toLocaleDateString()}</p>
                    <p class="text-sm text-gray-400 font-mono">ID: ${t.transactionId}</p>
                    ${isApproved ? `<button data-tx-id="${t.id}" class="download-admin-invoice-btn text-sky-400 hover:text-sky-300 flex items-center gap-2 pt-2"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> Download Invoice</button>` : ''}
                </div>`;
            }).join('');
            const historyView = `
                <div class="hidden md:block bg-gray-800/50 border border-gray-700 rounded-lg overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-900/70"><tr><th class="p-4">Customer</th><th class="p-4">Package</th><th class="p-4">Transaction ID</th><th class="p-4">Date</th><th class="p-4">Status</th><th class="p-4">Invoice</th></tr></thead>
                        <tbody class="divide-y divide-gray-700">${allTransactions.length > 0 ? historyTableHTML : `<tr><td colspan="6" class="text-center p-8 text-gray-400">No transactions found.</td></tr>`}</tbody>
                    </table>
                </div>
                <div class="md:hidden space-y-4">${allTransactions.length > 0 ? historyCardsHTML : `<div class="text-center p-8 text-gray-400">No transactions found.</div>`}</div>`;

            // --- CUSTOMERS VIEW ---
            const customersTableHTML = customerUsers.map(u => {
                const activeTx = transactions.find(t => t.userId === u.id && t.status === PackageStatus.ACTIVE);
                const activePkg = activeTx ? wifiPackages.find(p => p.id === activeTx.packageId) : null;
                return `<tr class="hover:bg-gray-700/50">
                    <td class="p-4 font-medium">${u.name}</td><td class="p-4 text-gray-300">${u.email}</td>
                    <td class="p-4 font-mono text-sm" id="assign-id-cell-${u.id}"><button data-user-id="${u.id}" class="edit-assign-id-btn hover:text-sky-300 transition-colors">${u.assignId || '<span class="text-gray-400 italic">Not Set</span>'}</button></td>
                    <td class="p-4 text-sky-400">${activePkg?.name || 'None'}</td><td class="p-4 text-gray-400">${new Date(u.createdAt).toLocaleDateString()}</td>
                </tr>`;
            }).join('');
            const customersCardsHTML = customerUsers.map(u => {
                const activeTx = transactions.find(t => t.userId === u.id && t.status === PackageStatus.ACTIVE);
                const activePkg = activeTx ? wifiPackages.find(p => p.id === activeTx.packageId) : null;
                 return `<div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4 space-y-2">
                    <div class="flex justify-between items-start"><span class="font-medium text-white">${u.name}</span><span class="text-sm text-gray-400">Joined: ${new Date(u.createdAt).toLocaleDateString()}</span></div>
                    <p class="text-sm text-gray-300">${u.email}</p>
                    <p class="text-sm">Active Pkg: <span class="text-sky-400">${activePkg?.name || 'None'}</span></p>
                    <div class="text-sm font-mono pt-1" id="assign-id-cell-mobile-${u.id}">Assign ID: <button data-user-id="${u.id}" class="edit-assign-id-btn hover:text-sky-300 transition-colors">${u.assignId || '<span class="text-gray-400 italic">Not Set</span>'}</button></div>
                 </div>`;
            }).join('');
            const customersView = `
                <div>
                    <div class="flex justify-end mb-4">
                        <button id="download-user-data-btn" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-500 transition-colors flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> Download All Data</button>
                    </div>
                    <div class="hidden md:block bg-gray-800/50 border border-gray-700 rounded-lg overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-900/70"><tr><th class="p-4">Name</th><th class="p-4">Email</th><th class="p-4">Assign ID</th><th class="p-4">Active Package</th><th class="p-4">Joined</th></tr></thead>
                            <tbody class="divide-y divide-gray-700" id="customer-table-body">${customersTableHTML}</tbody>
                        </table>
                    </div>
                    <div class="md:hidden space-y-4" id="customer-card-body">${customersCardsHTML}</div>
                </div>`;
            
            // --- COMPLAINTS VIEW ---
            const sortedComplaints = complaints.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const complaintsTableHTML = sortedComplaints.map(c => {
                 const customer = users.find(u => u.id === c.userId);
                 return `<tr class="hover:bg-gray-700/50">
                    <td class="p-4 font-medium">${customer?.name}</td><td class="p-4 text-gray-300">${c.subject}</td>
                    <td class="p-4 text-gray-400 max-w-sm truncate hidden md:table-cell">${c.message}</td><td class="p-4 text-gray-300">${new Date(c.timestamp).toLocaleDateString()}</td>
                    <td class="p-4">${getStatusPillHTML(c.status)}</td>
                    <td class="p-4">${c.status === ComplaintStatus.PENDING ? `<button data-complaint-id="${c.id}" class="resolve-complaint-btn p-2 bg-green-500/20 text-green-400 rounded-full hover:bg-green-500/40" title="Mark as Resolved"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>` : ''}</td>
                 </tr>`;
            }).join('');
            const complaintsCardsHTML = sortedComplaints.map(c => {
                 const customer = users.find(u => u.id === c.userId);
                 return `<div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4 space-y-2">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-medium text-white">${c.subject}</p>
                            <p class="text-sm text-gray-300">${customer?.name}</p>
                        </div>
                        ${getStatusPillHTML(c.status)}
                    </div>
                    <p class="text-sm text-gray-400 pt-2">${c.message}</p>
                    <div class="flex justify-between items-center pt-2">
                        <span class="text-xs text-gray-500">${new Date(c.timestamp).toLocaleString()}</span>
                        ${c.status === ComplaintStatus.PENDING ? `<button data-complaint-id="${c.id}" class="resolve-complaint-btn bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500/40 py-1 px-3 text-sm flex items-center gap-2">Resolve</button>` : ''}
                    </div>
                 </div>`;
            }).join('');
            const complaintsView = `
                <div class="flex justify-end mb-4">
                    <button id="download-complaints-btn" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-500 transition-colors flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> Download Complaints</button>
                </div>
                <div class="hidden md:block bg-gray-800/50 border border-gray-700 rounded-lg overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-900/70"><tr><th class="p-4">Customer</th><th class="p-4">Subject</th><th class="p-4 hidden md:table-cell">Message</th><th class="p-4">Date</th><th class="p-4">Status</th><th class="p-4">Actions</th></tr></thead>
                        <tbody class="divide-y divide-gray-700">${complaints.length > 0 ? complaintsTableHTML : `<tr><td colspan="6" class="text-center p-8 text-gray-400">No complaints found.</td></tr>`}</tbody>
                    </table>
                </div>
                <div class="md:hidden space-y-4">${complaints.length > 0 ? complaintsCardsHTML : `<div class="text-center p-8 text-gray-400">No complaints found.</div>`}</div>`;

            // --- PACKAGES VIEW ---
            const packagesTableHTML = wifiPackages.map(p => `
                <tr class="hover:bg-gray-700/50">
                    <td class="p-4 font-medium">${p.name}</td><td class="p-4 text-gray-300">${p.speed}</td>
                    <td class="p-4 font-mono text-sky-400">$${p.price.toFixed(2)}</td>
                    <td class="p-4"><button data-package-id="${p.id}" class="edit-package-btn bg-sky-600/80 text-white font-bold py-1 px-3 rounded hover:bg-sky-500">Edit</button></td>
                </tr>`).join('');
            const packagesCardsHTML = wifiPackages.map(p => `
                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div><p class="font-medium text-white">${p.name}</p><p class="text-sm text-gray-300">${p.speed}</p></div>
                        <p class="font-mono text-sky-400 text-lg">$${p.price.toFixed(2)}</p>
                    </div>
                    <div class="mt-4"><button data-package-id="${p.id}" class="edit-package-btn w-full bg-sky-600/80 text-white font-bold py-2 px-4 rounded hover:bg-sky-500">Edit</button></div>
                </div>`).join('');
            const packagesView = `
                <div class="hidden md:block bg-gray-800/50 border border-gray-700 rounded-lg overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-900/70"><tr><th class="p-4">Package Name</th><th class="p-4">Speed / Description</th><th class="p-4">Price</th><th class="p-4">Actions</th></tr></thead>
                        <tbody class="divide-y divide-gray-700">${packagesTableHTML}</tbody>
                    </table>
                </div>
                <div class="md:hidden space-y-4">${packagesCardsHTML}</div>`;

            // --- SETTINGS VIEW ---
            const settingsView = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-8">
                        <h3 class="text-xl font-bold text-sky-300 mb-6">Change Admin Credentials</h3>
                        <form id="credentials-form">
                            <div class="mb-4"><label class="block text-gray-300 font-medium mb-2">Username</label><input type="text" id="admin-username" value="${currentUser.email}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" /></div>
                            <div class="mb-6"><label class="block text-gray-300 font-medium mb-2">Password</label><input type="password" id="admin-password" value="${currentUser.password}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" /></div>
                            <button type="submit" class="w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-500">Update Credentials</button>
                        </form>
                    </div>
                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-8">
                        <h3 class="text-xl font-bold text-sky-300 mb-6">Update Payment Account</h3>
                        <form id="account-form">
                            <div class="mb-4"><label class="block text-gray-300 font-medium mb-2">Account Name</label><input type="text" id="account-name" value="${adminAccount.name}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" /></div>
                            <div class="mb-6"><label class="block text-gray-300 font-medium mb-2">Account Number</label><input type="text" id="account-number" value="${adminAccount.accountNumber}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" /></div>
                            <button type="submit" class="w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-500">Update Account</button>
                        </form>
                    </div>
                </div>`;
            
            // --- NOTIFICATIONS HISTORY VIEW ---
            const allNotificationsSorted = [...notifications].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const notificationHistoryTableHTML = allNotificationsSorted.map(n => {
                const recipientUser = users.find(u => u.id === n.userId);
                const recipientText = n.userId === 'all' ? 'Broadcast' : (recipientUser ? `${recipientUser.name}` : 'Unknown');
                return `<tr class="hover:bg-gray-700/50">
                    <td class="p-4 text-gray-300 whitespace-nowrap">${new Date(n.timestamp).toLocaleString()}</td>
                    <td class="p-4 font-medium">${recipientText}</td>
                    <td class="p-4 text-gray-400">${n.message}</td>
                </tr>`;
            }).join('');
            const notificationHistoryCardsHTML = allNotificationsSorted.map(n => {
                const recipientUser = users.find(u => u.id === n.userId);
                const recipientText = n.userId === 'all' ? 'Broadcast to Everyone' : (recipientUser ? `To: ${recipientUser.name}` : 'Unknown User');
                return `<div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4 space-y-2">
                    <p class="text-sm text-gray-400">${n.message}</p>
                    <div class="flex justify-between items-center text-xs pt-1">
                        <span class="font-medium text-gray-300">${recipientText}</span>
                        <span class="text-gray-500">${new Date(n.timestamp).toLocaleString()}</span>
                    </div>
                </div>`;
            }).join('');
            const notificationHistoryView = `
                <h2 class="text-2xl font-bold text-sky-300 mb-6">Sent Notification History</h2>
                <div class="hidden md:block bg-gray-800/50 border border-gray-700 rounded-lg overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-900/70"><tr><th class="p-4">Date</th><th class="p-4">Recipient</th><th class="p-4">Message</th></tr></thead>
                        <tbody class="divide-y divide-gray-700">${allNotificationsSorted.length > 0 ? notificationHistoryTableHTML : `<tr><td colspan="3" class="text-center p-8 text-gray-400">No notifications have been sent.</td></tr>`}</tbody>
                    </table>
                </div>
                <div class="md:hidden space-y-4">${allNotificationsSorted.length > 0 ? notificationHistoryCardsHTML : `<div class="text-center p-8 text-gray-400">No notifications have been sent.</div>`}</div>`;

            const activeClass = 'text-sky-400 border-b-2 border-sky-400';
            const inactiveClass = 'text-gray-400 hover:text-white';
            
            let mainContentHTML = '';
            switch(view) {
                case 'history': mainContentHTML = historyView; break;
                case 'customers': mainContentHTML = customersView; break;
                case 'complaints': mainContentHTML = complaintsView; break;
                case 'notifications': mainContentHTML = notificationHistoryView; break;
                case 'packages': mainContentHTML = packagesView; break;
                case 'settings': mainContentHTML = settingsView; break;
                default: mainContentHTML = transactionsView;
            }

            dashboardEl.innerHTML = `
                <div class="min-h-screen bg-gray-900 text-white p-4 sm:p-6 lg:p-8">
                    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                        <h1 class="text-3xl font-bold text-glow">Admin Portal</h1>
                        <div class="flex items-center flex-wrap gap-2 md:gap-4 self-end md:self-center">
                            <button id="theme-switcher-admin" class="theme-switcher-btn text-gray-300 hover:text-white transition-colors"></button>
                            <button id="show-notification-modal-btn" class="bg-sky-600/50 hover:bg-sky-500/50 border border-sky-600 hover:border-sky-500 text-white font-bold py-2 px-3 sm:px-4 rounded-lg transition-colors flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg> <span class="hidden sm:inline">Send Notification</span>
                            </button>
                            <button id="admin-logout-btn" class="bg-gray-700/50 hover:bg-red-500/50 border border-gray-600 hover:border-red-500 text-white font-bold py-2 px-3 sm:px-4 rounded-lg transition-colors flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg> <span class="hidden sm:inline">Logout</span>
                            </button>
                        </div>
                    </header>
                    <div class="border-b border-gray-700 mb-6 w-full overflow-x-auto">
                        <div class="flex space-x-2 sm:space-x-4 pb-2">
                            <button data-view="transactions" title="Pending Transactions" class="admin-nav-btn py-2 px-3 font-medium transition-colors flex items-center gap-2 whitespace-nowrap ${view === 'transactions' ? activeClass : inactiveClass}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> <span class="hidden sm:inline">Pending</span>
                                ${pendingTransactions.length > 0 ? `<span class="bg-sky-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${pendingTransactions.length}</span>` : ''}
                            </button>
                             <button data-view="history" title="Transaction History" class="admin-nav-btn py-2 px-3 font-medium transition-colors flex items-center gap-2 whitespace-nowrap ${view === 'history' ? activeClass : inactiveClass}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg> <span class="hidden sm:inline">History</span>
                            </button>
                            <button data-view="customers" title="Customer Management" class="admin-nav-btn py-2 px-3 font-medium transition-colors flex items-center gap-2 whitespace-nowrap ${view === 'customers' ? activeClass : inactiveClass}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.184-1.268-.5-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.184-1.268.5-1.857m0 0a5.002 5.002 0 019 0m-9 0a5.002 5.002 0 00-9 0" /></svg> <span class="hidden sm:inline">Customers</span>
                            </button>
                            <button data-view="complaints" title="Customer Complaints" class="admin-nav-btn py-2 px-3 font-medium transition-colors flex items-center gap-2 whitespace-nowrap ${view === 'complaints' ? activeClass : inactiveClass}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg> <span class="hidden sm:inline">Complaints</span>
                                 ${pendingComplaints.length > 0 ? `<span class="bg-yellow-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${pendingComplaints.length}</span>` : ''}
                            </button>
                             <button data-view="notifications" title="Notification History" class="admin-nav-btn py-2 px-3 font-medium transition-colors flex items-center gap-2 whitespace-nowrap ${view === 'notifications' ? activeClass : inactiveClass}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                 <span class="hidden sm:inline">Notifications</span>
                            </button>
                            <button data-view="packages" title="Package Management" class="admin-nav-btn py-2 px-3 font-medium transition-colors flex items-center gap-2 whitespace-nowrap ${view === 'packages' ? activeClass : inactiveClass}">
                               <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.293 2.293a1 1 0 010 1.414L10 12l5.707 5.293a1 1 0 010 1.414L13 21m-2-2l-2.293-2.293a1 1 0 010-1.414L13 12 7.293 6.707a1 1 0 010-1.414L10 3h2z" /></svg> <span class="hidden sm:inline">Packages</span>
                            </button>
                             <button data-view="settings" title="Settings" class="admin-nav-btn py-2 px-3 font-medium transition-colors flex items-center gap-2 whitespace-nowrap ${view === 'settings' ? activeClass : inactiveClass}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                 <span class="hidden sm:inline">Settings</span>
                            </button>
                        </div>
                    </div>
                    <main id="admin-main-content">${mainContentHTML}</main>
                </div>`;
        }

        function renderNotificationModal() {
            const container = document.getElementById('notification-modal-container');
            const customerUsers = users.filter(u => u.role === Role.CUSTOMER);
            container.innerHTML = `
                 <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div class="bg-gray-800 border border-sky-500 rounded-2xl p-8 max-w-lg w-full shadow-2xl shadow-sky-500/20">
                        <h2 class="text-2xl font-bold text-sky-300 mb-4">Send Notification</h2>
                        <form id="notification-form">
                            <div class="mb-4">
                                <label for="recipient" class="block text-gray-300 font-medium mb-2">Recipient</label>
                                <select id="recipient" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                                    <option value="all">Broadcast to Everyone</option>
                                    ${customerUsers.map(u => `<option value="${u.id}">${u.name} (${u.email})</option>`).join('')}
                                </select>
                            </div>
                            <div class="mb-6">
                                <label for="notification-message" class="block text-gray-300 font-medium mb-2">Message</label>
                                <textarea id="notification-message" rows="4" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" required></textarea>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <button type="button" id="cancel-notification" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500">Cancel</button>
                                <button type="submit" class="w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-500">Send</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            const close = () => { playSound('click'); container.innerHTML = ''; };
            document.getElementById('cancel-notification').addEventListener('click', close);
            document.getElementById('notification-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const recipient = document.getElementById('recipient').value;
                const message = document.getElementById('notification-message').value;
                if(message.trim()) {
                    handleSendNotification(recipient, message);
                    close();
                }
            });
        }

        function renderPackageEditModal(aPackage) {
            const container = document.getElementById('package-edit-modal-container');
            container.innerHTML = `
                <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div class="bg-gray-800 border border-sky-500 rounded-2xl p-8 max-w-lg w-full shadow-2xl shadow-sky-500/20">
                        <h2 class="text-2xl font-bold text-sky-300 mb-4">Edit Package: ${aPackage.name}</h2>
                        <form id="package-edit-form">
                            <div class="mb-4"><label class="block text-gray-300 font-medium mb-2">Package Name</label><input id="pkg-name" type="text" value="${aPackage.name}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" /></div>
                            <div class="mb-4"><label class="block text-gray-300 font-medium mb-2">Speed / Description</label><input id="pkg-speed" type="text" value="${aPackage.speed}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" /></div>
                            <div class="mb-6"><label class="block text-gray-300 font-medium mb-2">Price ($)</label><input id="pkg-price" type="number" value="${aPackage.price}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white" /></div>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <button type="button" id="cancel-pkg-edit" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500">Cancel</button>
                                <button type="submit" class="w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-500">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            const close = () => { playSound('click'); container.innerHTML = ''; };
            document.getElementById('cancel-pkg-edit').addEventListener('click', close);
            document.getElementById('package-edit-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('pkg-name').value;
                const speed = document.getElementById('pkg-speed').value;
                const price = Number(document.getElementById('pkg-price').value);
                handleUpdatePackage(aPackage.id, { name, speed, price });
                close();
            });
        }
        
        function setupDashboardDelegation() {
            // Customer Dashboard Delegation
            const customerDashboard = document.getElementById('customer-dashboard');
            customerDashboard.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                if (button.classList.contains('customer-nav-btn')) {
                    renderCustomerDashboard(button.dataset.view);
                } else if (button.id === 'customer-logout-btn') {
                    handleLogout();
                } else if (button.classList.contains('theme-switcher-btn')) {
                    toggleTheme();
                } else if (button.id === 'notification-bell') {
                    playSound('click');
                    document.getElementById('notification-dropdown').classList.toggle('hidden-view');
                } else if (button.classList.contains('buy-btn')) {
                    const pkgId = button.dataset.packageId;
                    const pkg = wifiPackages.find(p => p.id === pkgId);
                    if (pkg) {
                        playSound('click');
                        renderPurchaseModal(pkg);
                    }
                } else if (button.classList.contains('download-invoice-btn')) {
                    const txId = button.dataset.txId;
                    const tx = transactions.find(t => t.id === txId);
                    const pkg = wifiPackages.find(p => p.id === tx?.packageId);
                    if(tx && pkg && currentUser) {
                        playSound('click');
                        generateInvoice(tx, currentUser, pkg);
                    }
                } else if (button.id === 'mark-all-read-btn') {
                    handleMarkAllRead();
                }
            });

            customerDashboard.addEventListener('submit', (e) => {
                if (e.target.id === 'complaint-form') {
                    e.preventDefault();
                    const subject = document.getElementById('subject').value;
                    const message = document.getElementById('message').value;
                    if (subject.trim() && message.trim()) {
                        handleComplaintSubmit(currentUser.id, subject, message);
                    }
                }
            });
            
            // Admin Dashboard Delegation
            const adminDashboard = document.getElementById('admin-dashboard');
            adminDashboard.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                if (button.classList.contains('admin-nav-btn')) { renderAdminDashboard(button.dataset.view); }
                else if (button.id === 'admin-logout-btn') { handleLogout(); }
                else if (button.classList.contains('theme-switcher-btn')) { toggleTheme(); }
                else if (button.id === 'show-notification-modal-btn') { playSound('click'); renderNotificationModal(); }
                else if (button.classList.contains('approve-btn')) { handleApprove(button.dataset.txId); }
                else if (button.classList.contains('reject-btn')) { handleReject(button.dataset.txId); }
                else if (button.classList.contains('download-admin-invoice-btn')) {
                    const txId = button.dataset.txId;
                    const tx = transactions.find(t => t.id === txId);
                    const user = users.find(u => u.id === tx?.userId);
                    const pkg = wifiPackages.find(p => p.id === tx?.packageId);
                    if (tx && user && pkg) {
                        playSound('click');
                        generateInvoice(tx, user, pkg);
                    } else {
                        playSound('error');
                        console.error('Could not find transaction, user or package for invoice generation.');
                    }
                }
                else if (button.classList.contains('resolve-complaint-btn')) { handleResolveComplaint(button.dataset.complaintId); }
                else if (button.id === 'download-complaints-btn') {
                    playSound('click');
                    const dataToExport = complaints.map(c => {
                       const customer = users.find(u => u.id === c.userId);
                       return { complaintId: c.id, customerName: customer?.name || 'N/A', customerEmail: customer?.email || 'N/A', date: new Date(c.timestamp).toLocaleString(), subject: c.subject, message: c.message, status: c.status };
                   });
                   exportToCsv(dataToExport, 'all_complaints_data');
                }
                else if (button.classList.contains('edit-package-btn')) {
                    const pkg = wifiPackages.find(p => p.id === button.dataset.packageId);
                    if(pkg) renderPackageEditModal(pkg);
                }
                else if (button.id === 'download-user-data-btn') {
                    playSound('click');
                    const dataToExport = users.filter(u => u.role === Role.CUSTOMER).map(u => {
                       const userTransactions = transactions.filter(t => t.userId === u.id);
                       return { userId: u.id, assignId: u.assignId || 'N/A', name: u.name, email: u.email, totalPurchases: userTransactions.length,
                           totalSpent: userTransactions.filter(t => t.status === 'ACTIVE' || t.status === 'EXPIRED').reduce((sum, t) => sum + (wifiPackages.find(p => p.id === t.packageId)?.price || 0), 0),
                           joinedDate: new Date(u.createdAt).toLocaleDateString(),
                       };
                   });
                   exportToCsv(dataToExport, 'customer_history_data');
                }
                else if (button.classList.contains('edit-assign-id-btn')) {
                    const userId = button.dataset.userId;
                    const user = users.find(u => u.id === userId);
                    if(!user) return;

                    const renderInput = (cellId) => {
                        const cell = document.getElementById(cellId);
                        if (!cell) return;
                        const prefix = cellId.includes('mobile') ? 'Assign ID: ' : '';
                        cell.innerHTML = `
                        <div class="flex gap-2 items-center">
                            ${prefix}<input type="text" id="assign-id-input-${userId}" value="${user.assignId || ''}" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white w-28" autofocus />
                            <button data-user-id="${userId}" class="save-assign-id-btn text-green-400">Save</button>
                            <button data-user-id="${userId}" class="cancel-assign-id-btn text-red-400">X</button>
                        </div>`;
                        cell.querySelector('input').focus();
                    };
                    renderInput(`assign-id-cell-${userId}`);
                    renderInput(`assign-id-cell-mobile-${userId}`);
                }
                else if (button.classList.contains('save-assign-id-btn')) {
                    const userId = button.dataset.userId;
                    const newId = document.getElementById(`assign-id-input-${userId}`).value.trim();
                    if (newId) {
                      handleAssignId(userId, newId);
                    }
                    renderAdminDashboard('customers'); // Re-render to show updated state
                }
                else if (button.classList.contains('cancel-assign-id-btn')) {
                    renderAdminDashboard('customers'); // Re-render to cancel edit
                }
            });

            adminDashboard.addEventListener('submit', (e) => {
                e.preventDefault();
                if (e.target.id === 'credentials-form') {
                    handleUpdateCredentials(document.getElementById('admin-username').value, document.getElementById('admin-password').value);
                }
                if (e.target.id === 'account-form') {
                    handleUpdateAdminAccount(document.getElementById('account-name').value, document.getElementById('account-number').value);
                }
            });
        }
        
        // --- INITIALIZATION ---
        function init() {
            // Splash screen logic
            playSound('login');
            setTimeout(() => {
                const savedTheme = localStorage.getItem('ase_portal_theme') || 'dark';
                applyTheme(savedTheme);
                navigateTo('AUTH_SCREEN');
            }, 2500);

            // Set up one-time listeners to initialize audio context on user interaction
            window.addEventListener('click', initAudioContext, { once: true });
            window.addEventListener('keydown', initAudioContext, { once: true });

            // Auth screen event listeners
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('google-login-btn').addEventListener('click', handleGoogleLogin);
            document.getElementById('nav-to-signup').addEventListener('click', () => navigateTo('SIGNUP_SCREEN'));
            document.getElementById('nav-to-reset').addEventListener('click', () => navigateTo('RESET_PASSWORD_SCREEN'));
            
            // Signup screen event listeners
            document.getElementById('signup-form').addEventListener('submit', handleSignup);
            document.getElementById('nav-to-login-from-signup').addEventListener('click', () => navigateTo('AUTH_SCREEN'));
            
            // Reset password screen event listeners
            document.getElementById('reset-password-form').addEventListener('submit', handleResetPassword);
            document.getElementById('nav-to-login-from-reset').addEventListener('click', () => navigateTo('AUTH_SCREEN'));
            
            // Set up robust event listeners for dashboards
            setupDashboardDelegation();
        }

        // Run app
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>